/* Grapho Copyright (c) 2014 Robin Nilsson <robinnilsson@gmail.com> - MIT License */
(function(r,t){"function"===typeof define&&define.amd?define([],t):r.Grapho=t()})(this,function(){function r(a){var b;if(!(this instanceof r))return new r(a);this.yAxises=[];this.xAxises=[];this.datasets=[];this.container={width:"auto",height:"auto"};a.place&&(b=a.place,a.place=void 0);this.margin=5;a&&h.object.merge(this,a);void 0!==a.showLegend&&(this.showLegend=a.showLegend);this.legend=h.object.merge(v.legend,a.legend);this.id=t.push(this)-1;this.canvas=document.createElement("canvas");this.ctx=
this.canvas.getContext("2d");this.nwoy=this.nwox=this.woy=this.wox=this.wsh=this.wsw=this.h=this.w=0;b&&this.place(b);this.done=!0}var t=[],z={"default":function(a){var b;return h.math.isNumber(a)?Math.round(a,19)===(b=parseInt(a))?b:a:a},datetime:function(a){return h.math.isNumber(a)?(new Date(1E3*a)).toLocaleString():a},date:function(a){return h.math.isNumber(a)?(new Date(1E3*a)).toLocaleDateString():a},time:function(a){return h.math.isNumber(a)?(new Date(1E3*a)).toLocaleTimeString():a}},v={dataset:{type:"line",
x:{axis:1},y:{axis:1},lineWidth:2,lineSmooth:!0,strokeStyle:"#454545",fillStyle:"#343536",lineDots:!1,shadow:!0,dotWidth:4,barWidthPrc:90,_labels:[],_usedPos:[],_usedNeg:[]},axis:{min:"auto",max:"auto",showscale:!1,scaleStyle:"#FFFFFF",gridLines:!1,gridStyle:"#353637",name:void 0,font:"10px Droid Sans",labelFormat:z["default"],labelRotation:0,showlabels:!1,showCenter:!1,majorTickHeight:4,minorTickHeight:2,center:0,padded:!1,stacked:!1,numeric:!0,_textSize:0,_h:void 0,_step:Infinity,_steps:0,_minStepPrc:1,
_range:0,_startMinVal:0,_minVal:Infinity,_maxVal:-Infinity,_padded:!1,_values:[],_labels:[],_usedPos:[],_usedNeg:[]},legend:{position:"bottom",inside:!1,fillStyle:"none",strokeStyle:"none",font:"11px Droid Sans"}},h={array:{is:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},unique:function(a){for(var b={},c=[],d=0,f=a.length;d<f;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c}},object:{merge:function(a,b,c){var d;void 0===c&&(a=h.object.merge({},
a,!0));for(d in b)void 0!==b[d]&&(a[d]&&"[object Object]"===Object.prototype.toString.call(a[d])?a[d]=h.object.merge(h.object.merge({},a[d]),b[d],!0):"[object Array]"===h.array.is(b[d])?a[d]=b[d].slice():a[d]=b[d]);return a}},renderers:{line:function(a,b,c,d,f){var e,g,l,k,h,n,p,q;b.beginPath();g=d._minStepPrc;g*=a.wsw-g*a.wsw*(d._padded?1:0);k=d._padded?g/2:0;h=a.wsw-2*k;for(g=0;g<c.data.length;g++)if(e=c.data[g])n=(e[0]-d._minVal)/d._range,n=Math.round(a.wox+k+h*n),p=Math.round(a.woy+(e[1]+e[3]-
f._minVal)/f._range*a.wsh),g?c.lineSmooth&&g<c.data.length-1?(e=c.data[g+1],l=(e[0]-d._minVal)/d._range,b.quadraticCurveTo(n,p,(n+(e?Math.round(a.wox+k+h*l):0))/2,(p+(e?Math.round(a.woy+(e[1]-f._minVal)/f._range*a.wsh):0))/2)):b.lineTo(n-1,p):b.moveTo(q=n+1,p);b.lineWidth=c.lineWidth;b.strokeStyle=c.strokeStyle;b.stroke();"area"===c.type&&(a=Math.round(a.woy+((f.center<f._minVal?f._minVal:f.center>f._maxVal?f._maxVal:f.center)-f._minVal)/f._range*a.wsh)+.5,b.lineTo(n-1,a),b.lineTo(q,a),b.strokeStyle=
"rgba(0,0,0,0)",b.stroke(),b.fillStyle=c.fillStyle,b.fill())},bar:function(a,b,c,d,f){var e,g,h,k,u,n,p,q,m,s;k=d._minStepPrc;k*=a.wsw-k*a.wsw*(d._padded?1:0);h=d._padded?k/2:0;s=a.wsw-2*h;n=k*(100-c.barWidthPrc)/100;p=k-n;for(u=0;u<c.data.length;u++)if(e=c.data[u])g=(e[0]-d._minVal)/d._range,g=Math.round(a.wox-k/2+h+n/2+g*s),q=Math.round(a.woy+(e[1]+e[3]-f._minVal)/f._range*a.wsh),e=Math.round(a.woy+(e[3]-f._minVal)/f._range*a.wsh)-q,(m=Math.abs(e)>2*c.lineWidth)?b.fillStyle=c.fillStyle:b.fillStyle=
c.strokeStyle,b.fillRect(g,q,p,e),0<c.lineWidth&&m&&(b.strokeStyle=c.strokeStyle,b.lineWidth=c.lineWidth,b.strokeRect(Math.round(g+b.lineWidth/2),Math.round(q-b.lineWidth/2),p-b.lineWidth-.5,e+b.lineWidth-1))},scatter:function(a,b,c,d,f){var e,g,h,k,u;e=d._minStepPrc;e*=a.wsw-e*a.wsw*(d._padded?1:0);h=d._padded?e/2:0;u=a.wsw-2*h;for(k=0;k<c.data.length;k++)if(e=c.data[k])g=(e[0]-d._minVal)/d._range,b.beginPath(),b.arc(Math.round(a.wox+h+u*g),Math.round(a.woy+(e[1]+e[3]-f._minVal)/f._range*a.wsh),
c.dotWidth,0,2*Math.PI),b.fillStyle=c.fillStyle,b.fill()},pie:function(a,b,c,d,f){for(d=0;d<c.data.length;d++){var e=b,g=a.wsw/2+a.wox,l=a.wsh/2+a.woy,k=1*(a.wsw>a.wsh?a.wsh/2:a.wsw/2),u=c.data[d][3]/f._usedPos[d]*360*h.math.degToRad,n=u+c.data[d][1]/f._usedPos[d]*360*h.math.degToRad;e.beginPath();e.moveTo(g,l);e.arc(g,l,k,u,n,!1);e.closePath();e.fillStyle=c.fillStyle;e.fill();e.lineWidth=c.lineWidth;e.strokeStyle=c.strokeStyle;e.stroke()}}},math:{degToRad:.0174532925,log10:function(a){return Math.log(a)/
Math.LN10},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},isInt:function(a){return 0===a%1},bboxrot:function(a,b,c){var d=h.math.degToRad*c,f,e;a/=2;b/=2;c=a*Math.cos(d)+b*Math.sin(d);f=-a*Math.sin(d)+b*Math.cos(d);e=a*Math.cos(d)-b*Math.sin(d);a=-a*Math.sin(d)-b*Math.cos(d);return{width:Math.round(Math.max(Math.abs(2*c),Math.abs(2*e))),height:Math.round(Math.max(Math.abs(2*f),Math.abs(2*a)))}}}},m;m=r.prototype;r.formats=m.formats=z;m.place=function(a){var b;"string"===typeof a&&
(a=document.getElementById(a));if(b=a&&(a.appendChild?"appendChild":"append"))this.dest=a,this.dest[b](this.canvas),this.resize(this);return this};m.initAxis=function(a,b){var c=v.axis,d=a.axis;"number"===typeof d&&isFinite(d)&&0===d%1&&(void 0===b[d]?("object"===typeof a&&(c=h.object.merge(c,a)),b[d]=c):"object"===typeof a&&(c=h.object.merge(b[d],a),b[d]=c));return this};m.removeDataset=function(a){a=this.datasets.indexOf(a);-1!==a&&this.datasets.splice(a)};m.addDataset=function(a){var b=h.array.is(a);
if("object"!==typeof a||!b&&!a.data)return this;var c=v.dataset;b?c.data=a:c=h.object.merge(c,a);"bar"===a.type&&void 0===a.lineWidth&&(c.lineWidth=0);this.initAxis(c.y,this.yAxises);this.initAxis(c.x,this.xAxises);this.pushDataset(c);!0===this.done&&this.redraw();return c};m.updateAxises=function(a){var b=this.yAxises[a.y.axis],c=this.xAxises[a.x.axis],d,f,e,g=a.data.length,l=[],k=[];if(!h.array.is(a.data[0]))for(d=0;d<g;d++)l[d]=a.data[d],k[d]=d,a.data[d]=[d,a.data[d]];for(d=0;d<g;d++){void 0!==
a.data[d][2]&&(a.data[d][0]=a.data[d][2]);e=-1;for(f=0;f<c._labels.length;f++)c._labels[f]===a.data[d][0]&&(e=f);a.data[d][2]=a.data[d][0];-1<e?(a.data[d][0]=k[d]=e,a.data[d][1]=l[d]=a.data[d][1]):(l[d]=a.data[d][1],e=c._labels.push(a.data[d][0])-1,a.data[d][0]=k[d]=e);a.data[d][3]=0;void 0===b._usedPos[e]&&(b._usedPos[e]=0);void 0===b._usedNeg[e]&&(b._usedNeg[e]=0);if(b.stacked||"pie"===a.type)a.data[d][1]>=b.center?(a._usedPos[e]=a.data[d][3]=void 0===b._usedPos[e]?0:b._usedPos[e],b._usedPos[e]+=
a.data[d][1]):(a._usedNeg[e]=a.data[d][3]=void 0===b._usedNeg[e]?0:b._usedNeg[e],b._usedNeg[e]+=a.data[d][1])}"string"===typeof a.data[0][0]&&(c.numeric=!0);b.stacked?(b._maxVal="auto"!==b.max?b.max:Math.max(Math.max.apply(null,b._usedPos),b._maxVal),b._minVal="auto"!==b.min?b.min:Math.min(Math.min.apply(null,b._usedNeg),b._minVal)):(b._maxVal="auto"!==b.max?b.max:Math.max(Math.max.apply(null,l),b._maxVal),b._minVal="auto"!==b.min?b.min:Math.min(Math.min.apply(null,l),b._minVal));c._maxVal="auto"!==
c.max?c.max:Math.max(Math.max.apply(null,k),c._maxVal);c._minVal="auto"!==c.min?c.min:Math.min(Math.min.apply(null,k),c._minVal);c._values=h.array.unique(c._values.concat(k));b._values=h.array.unique(b._values.concat(l));c._range=c._maxVal-c._minVal;b._range=b._maxVal-b._minVal;a.data.sort(function(a,b){return a[0]-b[0]});c=this.calcMinStep(c,a.data,0);b=this.calcMinStep(b,a.data,1);!0!==c.numeric?(c._step=1,c._steps=c._labels.length-1):c=this.calcAxisSteps(c);b=this.calcAxisSteps(b);"bar"===a.type&&
(c._padded=!0);return this};m.pushDataset=function(a){var b;this.xAxises[a.x.axis]._values=[];this.yAxises[a.y.axis]._values=[];this.xAxises[a.x.axis]._labels=[];this.yAxises[a.y.axis]._labels=[];this.yAxises[a.y.axis]._usedPos=[];this.yAxises[a.y.axis]._usedNeg=[];for(b=0;b<this.datasets.length;b++)this.datasets[b].x.axis!==a.x.axis&&this.datasets[b].y.axis!==a.y.axis||this.updateAxises(this.datasets[b]);this.updateAxises(a);this.datasets.push(a);return this};m.calcAxisSteps=function(a,b){var c,
d,f;c=a._range/(void 0===b?15:b);f=a._range*a._minStepPrc;d=Math.floor(h.math.log10(c));d=Math.pow(10,d);c=Math.round(c/d+.5);5<c?c=10:2<c?c=5:1<c&&(c=2);c*=d;c<f&&(c=f);a._startMinVal=a._minVal-a._minVal%c;f=Math.round(Math.ceil(a._range/c));a._step=c;a._steps=f;return a};m.calcMinStep=function(a,b,c){var d,f=a._minStepPrc,e,g;for(d=0;d<b.length;d++)if(g=b[d])g=(g[c]-a._minVal)/a._range,void 0!==e&&g-e<f&&(f=g-e),e=g;a._minStepPrc=f;return a};m.drawAxis=function(a,b,c,d){var f,e,g,l,k,m,n,p,q,r,
s,w,t,v,x,y;a.lineWidth=1;a.strokeStyle=b.gridStyle;l="x"===c?this.w:this.h;k="x"===c?this.h:this.w;"x"===c?(a.save(),a.scale(1,-1),a.translate(0,-this.h),a.translate(0,k),a.rotate(-.5*Math.PI),q=this.wsh,r=this.wsw,s=this.woy,w=this.wox):(q=this.wsw,r=this.wsh,w=this.woy,s=this.wox);f=b._minStepPrc;f*=q-f*q*(b._padded?1:0);x=b._padded?f/2:0;v=q-2*x;a.font=b.font;m=[+Math.abs(b._step),-Math.abs(b._step)];for(n=0;n<m.length;n++)for(p=b._startMinVal;p<=b._maxVal&&p>=b._minVal;)f=Math.round(s+x+(p-b._minVal)/
b._range*v),b.showGridLines&&(a.beginPath(),a.moveTo(f,w),a.lineTo(f,w+r),a.strokeStyle=b.gridStyle,a.stroke()),b.showLabels&&(a.save(),a.beginPath(),y=b.labelRotation+90+("y"===c?90:0),t=b._labels&&void 0!==b._labels[p]?b.labelFormat(b._labels[p]):b.labelFormat(p),g=h.math.bboxrot(a.measureText(t).width,b._textSize,y),"y"===c?(a.scale(-1,1),a.translate(-this.w,0),e=k-f):e=f,g=b._offset+b._h-g.height/2-(b.showScale?b.majorTickHeight+1:0)-2,d||(g=l-g),a.translate(e,g),a.rotate(y*h.math.degToRad),a.translate(-a.measureText(t).width/
2,b._textSize/3),a.fillStyle=b.scaleStyle,a.fillText(t,0,0),a.restore()),b.showScale&&(a.beginPath(),e=b._offset+b._h-1,d?(a.moveTo(f,e),a.lineTo(f,e-b.majorTickHeight)):(a.moveTo(f,l-e),a.lineTo(f,l-e+b.majorTickHeight)),a.strokeStyle=b.scaleStyle,a.stroke()),p+=m[n];b.showCenter&&b.center>b._minVal&&b.center<b._maxVal&&(f=Math.round(s+x+(b.center-b._minVal)/b._range*v),a.beginPath(),a.moveTo(f,w),a.lineTo(f,w+r),a.strokeStyle=b.scaleStyle,a.stroke());b.showScale&&(a.beginPath(),d?(a.moveTo(s,b._offset+
b._h-1),a.lineTo(s+q,b._offset+b._h-1)):(a.moveTo(s,l-b._offset-b._h+1),a.lineTo(s+q,l-b._offset-b._h+1)),a.strokeStyle=b.scaleStyle,a.stroke());b.name&&(a.font=b.font,a.fillStyle=b.scaleStyle,f=d?b._offset+b._textSize/1.2:l-b._offset-b._textSize/2.2,a.save(),"y"===c?(a.scale(1,-1),a.translate(0,-this.h),e=l-f+b._textSize/1.9):e=f,a.fillText(b.name,s+q/2-a.measureText(b.name).width/2,e),a.restore());"x"===c&&a.restore()};m.drawLegend=function(a){var b=0,c=0,d=1,f=1.2*parseInt(a.font.split(" ")[0]),
e,g;this.ctx.font=a.font;for(e=0;e<this.datasets.length;e++)void 0===this.datasets[e].name&&(this.datasets[e].name="Series "+(e+1)),"bottom"===a.position||"top"===a.position?(c+this.ctx.measureText(this.datasets[e].name).width+f+f>this.w-2*this.margin&&(d+=1,c=0),c+=this.ctx.measureText(this.datasets[e].name).width+f+f,b=f*d):((g=this.ctx.measureText(this.datasets[e].name).width)>c&&(c=g),b=c+f);c=0;d=1;for(e=0;e<this.datasets.length;e++)this.ctx.fillStyle=this.datasets[e].fillStyle,this.ctx.strokeStyle=
this.datasets[e].strokeStyle,"bottom"===a.position||"top"===a.position?(c+this.ctx.measureText(this.datasets[e].name).width+f+f>this.w-2*this.margin&&(d+=1,c=0),g=("bottom"===a.position?this.h-b-this.margin:0)+(d-1)*f+3,this.ctx.fillRect(c,g,f-6,f-6),this.ctx.strokeRect(c,g,f-6,f-6),this.ctx.fillText(this.datasets[e].name,c+f,g+f/1.35),c+=this.ctx.measureText(this.datasets[e].name).width+f+f):(g="right"===a.position?this.w-this.margin-b:0,this.ctx.fillRect(g,(d-1)*f+3,f-6,f-6),this.ctx.strokeRect(g,
(d-1)*f+3,f-6,f-6),this.ctx.fillText(this.datasets[e].name,g+f,(d-1)*f+f/1.35),d+=1);return b};m.redraw=function(){var a,b,c,d,f,e,g,l=function(a,b,c){a._textSize=void 0!==a.font?parseInt(a.font.split(" ")[0]):0;a._h=0;a._h+=a.showScale?1:0;a._h+=a.showScale?a.majorTickHeight:0;a._h+=a.name?a._textSize:0;if(a.showLabels){d=0;for(f=a._minVal;f<=a._maxVal;f+=a._step)e=a._labels&&void 0!==a._labels[f]?b.measureText(a.labelFormat(a._labels[f])).width:b.measureText(a.labelFormat(f)).width,g=a._textSize,
e=h.math.bboxrot(e,g,a.labelRotation+("x"===c?90:0)).width,e>d&&(d=e);a._h+=d}return a};this.wsw=this.w-2*this.margin;this.wsh=this.h-2*this.margin;this.nwoy=this.nwox=this.woy=this.wox=this.margin;b=this.ctx;b.clearRect(0,0,this.w,this.h);this.showLegend&&!this.legend.inside&&(c=this.drawLegend(this.legend)+this.margin,"bottom"===this.legend.position?(this.woy+=c,this.wsh-=c):"top"===this.legend.position?(this.nwoy+=c,this.wsh-=c):"left"===this.legend.position?(this.wox+=c,this.wsw-=c):"right"===
this.legend.position&&(this.nwox+=c,this.wsw-=c));b.save();b.translate(.5,.5);b.scale(1,-1);b.translate(0,-this.h);for(a in this.yAxises)this.yAxises.hasOwnProperty(a)&&(this.yAxises[a]=l(this.yAxises[a],this.ctx,"y"),this.wsw-=this.yAxises[a]._h,this.yAxises[a]._offset=a%2?this.wox:this.nwox,a%2?this.wox+=this.yAxises[a]._h:this.nwox+=this.yAxises[a]._h);for(a in this.xAxises)this.xAxises.hasOwnProperty(a)&&(this.xAxises[a]=l(this.xAxises[a],this.ctx,"x"),this.wsh-=this.xAxises[a]._h,this.xAxises[a]._offset=
a%2?this.woy:this.nwoy,a%2?this.woy+=this.xAxises[a]._h:this.nwoy+=this.xAxises[a]._h);for(a in this.yAxises)this.yAxises.hasOwnProperty(a)&&this.drawAxis(b,this.yAxises[a],"x",a%2);for(a in this.xAxises)this.xAxises.hasOwnProperty(a)&&this.drawAxis(b,this.xAxises[a],"y",a%2);for(a=this.datasets.length-1;0<=a;a--)if(c=this.datasets[a],void 0!==h.renderers[c.type]||"area"===c.type){if("line"===c.type||"area"===c.type)h.renderers.line(this,b,c,this.xAxises[c.x.axis],this.yAxises[c.y.axis]);else h.renderers[c.type](this,
b,c,this.xAxises[c.x.axis],this.yAxises[c.y.axis]);c.lineDots&&h.renderers.scatter(this,b,c,this.xAxises[c.x.axis],this.yAxises[c.y.axis])}else console.error('Grapho: Missing renderer "'+c.type+'", cannot render dataset.');b.restore()};m.resize=function(){"auto"===(this.w=this.container.width)&&(this.w=getComputedStyle(this.dest,null).getPropertyValue("width"));"auto"===(this.h=this.container.height)&&(this.h=getComputedStyle(this.dest,null).getPropertyValue("height"));this.canvas.height=this.h=parseInt(this.h);
this.canvas.width=this.w=parseInt(this.w);this.redraw();return this};window.addEventListener("resize",function(){for(var a,b=0;a=t[b++];)a.resize()});return r});