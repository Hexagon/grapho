/* Grapho Copyright (c) 2014 Robin Nilsson <robinnilsson@gmail.com> - MIT License */
(function(s,u){"function"===typeof define&&define.amd?define([],u):s.Grapho=u()})(this,function(){function s(a){if(!(this instanceof s))return new s(a);this.yAxises=[];this.xAxises=[];this.datasets=[];this.container=v.container;this.settings=l.object.merge(v.settings,a);this.id=u.push(this)-1;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.nwoy=this.nwox=this.woy=this.wox=this.wsh=this.wsw=this.h=this.w=0;a.place&&this.place(a.place);this.done=!0}var u=[],y=
{"default":function(a){var b;return l.math.isNumber(a)?Math.round(a,19)===(b=parseInt(a))?b:a:a},datetime:function(a){return l.math.isNumber(a)?(new Date(1E3*a)).toLocaleString():a},date:function(a){return l.math.isNumber(a)?(new Date(1E3*a)).toLocaleDateString():a},time:function(a){return l.math.isNumber(a)?(new Date(1E3*a)).toLocaleTimeString():a}},v={container:{width:"auto",height:"auto"},settings:{margin:5,showLegend:!1,fillStyle:"rgb(0,0,0,0)",legend:{position:"bottom",inside:!1,fillStyle:"none",
strokeStyle:"none",font:"11px Droid Sans"},startAngle:90,sizePercent:1,relative:!0,innerMargin:3},dataset:{type:"line",x:{axis:1},y:{axis:1},lineWidth:2,lineSmooth:!0,strokeStyle:"#454545",fillStyle:"#343536",dotWidth:4,widthPrc:90,_labels:[],_usedPos:[],_usedNeg:[],_data:[]},axis:{min:"auto",max:"auto",showscale:!1,scaleStyle:"#FFFFFF",gridLines:!1,gridStyle:"#353637",name:void 0,font:"10px Droid Sans",labelFormat:y["default"],labelRotation:0,showlabels:!1,showCenter:!1,majorTickHeight:4,center:0,
padded:!1,stacked:!1,numeric:!0,_textSize:0,_h:void 0,_step:Infinity,_steps:0,_minStepPrc:1,_range:0,_startMinVal:0,_minVal:Infinity,_maxVal:-Infinity,_padded:!1,_values:[],_labels:[],_usedPos:[],_usedNeg:[]}},l={array:{is:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},unique:function(a){for(var b={},c=[],d=0,f=a.length;d<f;++d)b.hasOwnProperty(a[d])||(c.push(a[d]),b[a[d]]=1);return c}},object:{merge:function(a,b,c){var d;void 0===c&&(a=l.object.merge({},a,
!0));for(d in b)void 0!==b[d]&&(a[d]&&"[object Object]"===Object.prototype.toString.call(a[d])?a[d]=l.object.merge(l.object.merge({},a[d]),b[d],!0):"[object Array]"===l.array.is(b[d])?a[d]=b[d].slice():a[d]=b[d]);return a}},renderers:{line:function(a,b,c,d,f){var e,g,h,k,r,n,p,m;b.beginPath();g=d._minStepPrc;g*=a.wsw-g*a.wsw*(d._padded?1:0);k=d._padded?g/2:0;r=a.wsw-2*k;for(g=0;g<c.data.length;g++)if(e=c.data[g])n=(e[0]-d._minVal)/d._range,n=Math.round(a.wox+k+r*n),p=Math.round(a.woy+(e[1]+e[3]-f._minVal)/
f._range*a.wsh),g?c.lineSmooth&&g<c.data.length-1?(e=c.data[g+1],h=(e[0]-d._minVal)/d._range,b.quadraticCurveTo(n,p,(n+(e?Math.round(a.wox+k+r*h):0))/2,(p+(e?Math.round(a.woy+(e[1]-f._minVal)/f._range*a.wsh):0))/2)):b.lineTo(n-1,p):b.moveTo(m=n+1,p);b.lineWidth=c.lineWidth;b.strokeStyle=c.strokeStyle;b.stroke();"area"===c.type&&(a=Math.round(a.woy+((f.center<f._minVal?f._minVal:f.center>f._maxVal?f._maxVal:f.center)-f._minVal)/f._range*a.wsh)+.5,b.lineTo(n-1,a),b.lineTo(m,a),b.strokeStyle="rgba(0,0,0,0)",
b.stroke(),b.fillStyle=c.fillStyle,b.fill())},band:function(a,b,c,d,f){var e,g,h,k,r,n,p,m;b.beginPath();g=d._minStepPrc;g*=a.wsw-g*a.wsw*(d._padded?1:0);n=d._padded?g/2:0;p=a.wsw-2*n;for(h=0;2>h;h++)for(g=0;g<c.data.length;g++)if(k=0===h?g:c.data.length-g-1,e=c.data[k])m=(e[0]-d._minVal)/d._range,m=Math.round(a.wox+n+p*m),e=Math.round(a.woy+(e[1][h]-f._minVal)/f._range*a.wsh),k||0!==h?c.lineSmooth&&k<c.data.length-1&&0<k?(k=c.data[k+(h?-1:1)],r=(k[0]-d._minVal)/d._range,b.quadraticCurveTo(m,e,(m+
(k?Math.round(a.wox+n+p*r):0))/2,(e+(k?Math.round(a.woy+(k[1][h]-f._minVal)/f._range*a.wsh):0))/2)):b.lineTo(m-1,e):b.moveTo(m+1,e);b.fillStyle=c.fillStyle;b.fill()},error:function(a,b,c,d,f){var e,g,h,k,r,n,p,m,l;h=d._minStepPrc;h*=a.wsw-h*a.wsw*(d._padded?1:0);k=d._padded?h/2:0;r=a.wsw-2*k;p=h*(100-c.widthPrc)/100;n=h-p;b.strokeStyle=c.strokeStyle;for(g=0;g<c.data.length;g++)if(e=c.data[g])m=Math.round(a.wox-h/2+k+p/2+(e[0]-d._minVal)/d._range*r),l=Math.round(a.woy+(e[1][0]-f._minVal)/f._range*
a.wsh),e=Math.round(a.woy+(e[1][1]-f._minVal)/f._range*a.wsh),b.beginPath(),b.moveTo(m,l),b.lineTo(m+n,l),b.moveTo(Math.round(m+n/2),l),b.lineTo(Math.round(m+n/2),e),b.moveTo(m,e),b.lineTo(m+n,e),b.stroke()},bar:function(a,b,c,d,f){var e,g,h,k,l,n,p,m,q,t;k=d._minStepPrc;k*=a.wsw-k*a.wsw*(d._padded?1:0);h=d._padded?k/2:0;t=a.wsw-2*h;n=k*(100-c.widthPrc)/100;p=k-n;for(l=0;l<c.data.length;l++)if(e=c.data[l])g=(e[0]-d._minVal)/d._range,g=Math.round(a.wox-k/2+h+n/2+g*t),m=Math.round(a.woy+(e[1]+e[3]-
f._minVal)/f._range*a.wsh),e=Math.round(a.woy+(e[3]-f._minVal)/f._range*a.wsh)-m,(q=Math.abs(e)>2*c.lineWidth)?b.fillStyle=c.fillStyle:b.fillStyle=c.strokeStyle,b.fillRect(g,m,p,e),0<c.lineWidth&&q&&(b.strokeStyle=c.strokeStyle,b.lineWidth=c.lineWidth,b.strokeRect(Math.round(g+b.lineWidth/2),Math.round(m-b.lineWidth/2),p-b.lineWidth-.5,e+b.lineWidth-1))},scatter:function(a,b,c,d,f){var e,g,h,k,l;e=d._minStepPrc;e*=a.wsw-e*a.wsw*(d._padded?1:0);h=d._padded?e/2:0;l=a.wsw-2*h;for(k=0;k<c.data.length;k++)if(e=
c.data[k])g=(e[0]-d._minVal)/d._range,b.beginPath(),b.arc(Math.round(a.wox+h+l*g),Math.round(a.woy+(e[1]+e[3]-f._minVal)/f._range*a.wsh),c.dotWidth,0,2*Math.PI),b.fillStyle=c.fillStyle,b.fill()},pie:function(a,b,c,d,f){var e=1-a.settings.sizePercent,g;for(d=0;d<c.data.length;d++){g=1-d/c.data.length*(1-e);b.fillStyle=c.fillStyle;var h=b,k=a.wsw/2+a.wox,r=a.wsh/2+a.woy,n=(a.wsw>a.wsh?a.wsh/2:a.wsw/2)*(g+.01);g=(a.wsw>a.wsh?a.wsh/2:a.wsw/2)*(g-1/c.data.length*(1-e))+a.settings.innerMargin;var p=(c.data[d][3]/
f._usedPos[d]*360+a.settings.startAngle)*l.math.degToRad,m=p+(c.data[d][1]/f._usedPos[d]*360+.5)*l.math.degToRad;h.beginPath();h.arc(k,r,n,p,m,!1);h.arc(k,r,g,m,p,!0);h.closePath();h.fill()}}},math:{degToRad:.0174532925,log10:function(a){return Math.log(a)/Math.LN10},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},isInt:function(a){return 0===a%1},bboxrot:function(a,b,c){c*=l.math.degToRad;return{width:Math.max(Math.abs(a*Math.cos(c)+b*Math.sin(c)),Math.abs(a*Math.cos(c)-b*Math.sin(c))),
height:Math.max(Math.abs(-a*Math.sin(c)+b*Math.cos(c)),Math.abs(-a*Math.sin(c)-b*Math.cos(c)))}}}},q;q=s.prototype;s.formats=q.formats=y;q.place=function(a){var b;"string"===typeof a&&(a=document.getElementById(a));if(b=a&&(a.appendChild?"appendChild":"append"))this.dest=a,this.dest[b](this.canvas),this.resize(this);return this};q.removeDataset=function(a){a=this.datasets.indexOf(a);-1!==a&&this.datasets.splice(a)};q.addDataset=function(a){var b=l.array.is(a);if("object"!==typeof a||!b&&!a.data)return this;
var c=v.dataset;b?c.data=a:c=l.object.merge(c,a);"bar"===a.type&&void 0===a.lineWidth&&(c.lineWidth=0);this.yAxises[c.y.axis]=l.object.merge(v.axis,l.object.merge(this.yAxises[c.y.axis],c.y));this.xAxises[c.x.axis]=l.object.merge(v.axis,l.object.merge(this.xAxises[c.x.axis],c.x));this.pushDataset(c);this.done&&this.redraw();return c};q.updateAxises=function(a){var b=this.yAxises[a.y.axis],c=this.xAxises[a.x.axis],d,f,e,g=a.data.length,h=[],k=[];if(!l.array.is(a.data[0]))for(d=0;d<g;d++)h[d]=a.data[d],
k[d]=d,a.data[d]=[d,a.data[d]];for(d=0;d<g;d++){void 0!==a.data[d][2]&&(a.data[d][0]=a.data[d][2]);e=-1;for(f=0;f<c._labels.length;f++)c._labels[f]===a.data[d][0]&&(e=f);a.data[d][2]=a.data[d][0];-1<e||(e=c._labels.push(a.data[d][0])-1);a.data[d][0]=k[d]=e;l.array.is(a.data[d][1])?h=h.concat(a.data[d][1]):h[d]=a.data[d][1];a.data[d][3]=0;!l.array.is(a.data[d][1])&&(void 0===b._usedPos[e]&&(b._usedPos[e]=0),void 0===b._usedNeg[e]&&(b._usedNeg[e]=0),b.stacked||"pie"===a.type||"progress"===a.type)&&
(a.data[d][1]>=b.center?(a._usedPos[e]=a.data[d][3]=void 0===b._usedPos[e]?0:b._usedPos[e],b._usedPos[e]+=a.data[d][1]):(a._usedNeg[e]=a.data[d][3]=void 0===b._usedNeg[e]?0:b._usedNeg[e],b._usedNeg[e]+=a.data[d][1]))}"string"===typeof a.data[0][0]&&(c.numeric=!0);b.stacked?(b._maxVal="auto"!==b.max?b.max:Math.max(Math.max.apply(null,b._usedPos),b._maxVal),b._minVal="auto"!==b.min?b.min:Math.min(Math.min.apply(null,b._usedNeg),b._minVal)):(b._maxVal="auto"!==b.max?b.max:Math.max(Math.max.apply(null,
h),b._maxVal),b._minVal="auto"!==b.min?b.min:Math.min(Math.min.apply(null,h),b._minVal));c._maxVal="auto"!==c.max?c.max:Math.max(Math.max.apply(null,k),c._maxVal);c._minVal="auto"!==c.min?c.min:Math.min(Math.min.apply(null,k),c._minVal);c._values=l.array.unique(c._values.concat(k));b._values=l.array.unique(b._values.concat(h));c._range=c._maxVal-c._minVal;b._range=b._maxVal-b._minVal;a.data.sort(function(a,b){return a[0]-b[0]});c=this.calcMinStep(c,a.data,0);b=this.calcMinStep(b,a.data,1);!0!==c.numeric?
(c._step=1,c._steps=c._labels.length-1):c=this.calcAxisSteps(c);b=this.calcAxisSteps(b);"bar"===a.type&&(c._padded=!0);return this};q.pushDataset=function(a){var b;this.xAxises[a.x.axis]._values=[];this.yAxises[a.y.axis]._values=[];this.xAxises[a.x.axis]._labels=[];this.yAxises[a.y.axis]._labels=[];this.yAxises[a.y.axis]._usedPos=[];this.yAxises[a.y.axis]._usedNeg=[];for(b=0;b<this.datasets.length;b++)this.datasets[b].x.axis!==a.x.axis&&this.datasets[b].y.axis!==a.y.axis||this.updateAxises(this.datasets[b]);
this.updateAxises(a);this.datasets.push(a);return this};q.calcAxisSteps=function(a,b){var c,d,f;c=a._range/(void 0===b?15:b);f=a._range*a._minStepPrc;d=Math.floor(l.math.log10(c));d=Math.pow(10,d);c=Math.round(c/d+.5);5<c?c=10:2<c?c=5:1<c&&(c=2);c*=d;c<f&&(c=f);a._startMinVal=a._minVal-a._minVal%c;f=Math.round(Math.ceil(a._range/c));a._step=c;a._steps=f;return a};q.calcMinStep=function(a,b,c){var d,f=a._minStepPrc,e,g;for(d=0;d<b.length;d++)if(g=b[d])g=(g[c]-a._minVal)/a._range,void 0!==e&&g-e<f&&
(f=g-e),e=g;a._minStepPrc=f;return a};q.drawAxis=function(a,b,c,d){var f,e,g,h,k,r,n,p,m,q,t,s,u,v,w,x;a.lineWidth=1;a.strokeStyle=b.gridStyle;h="x"===c?this.w:this.h;k="x"===c?this.h:this.w;"x"===c?(a.save(),a.scale(1,-1),a.translate(0,-this.h),a.translate(0,k),a.rotate(-.5*Math.PI),m=this.wsh,q=this.wsw,t=this.woy,s=this.wox):(m=this.wsw,q=this.wsh,s=this.woy,t=this.wox);f=b._minStepPrc;f*=m-f*m*(b._padded?1:0);w=b._padded?f/2:0;v=m-2*w;a.font=b.font;r=[+Math.abs(b._step),-Math.abs(b._step)];for(n=
0;n<r.length;n++)for(p=b._startMinVal;p<=b._maxVal&&p>=b._minVal;)f=Math.round(t+w+(p-b._minVal)/b._range*v),b.showGridLines&&(a.beginPath(),a.moveTo(f,s),a.lineTo(f,s+q),a.strokeStyle=b.gridStyle,a.stroke()),b.showLabels&&(a.save(),a.beginPath(),x=b.labelRotation+90+("y"===c?90:0),u=b._labels&&void 0!==b._labels[p]?b.labelFormat(b._labels[p]):b.labelFormat(p),g=l.math.bboxrot(a.measureText(u).width,b._textSize,x),"y"===c?(a.scale(-1,1),a.translate(-this.w,0),e=k-f):e=f,g=b._offset+b._h-g.height/
2-(b.showScale?b.majorTickHeight+1:0)-2,d||(g=h-g),a.translate(e,g),a.rotate(x*l.math.degToRad),a.translate(-a.measureText(u).width/2,b._textSize/3),a.fillStyle=b.scaleStyle,a.fillText(u,0,0),a.restore()),b.showScale&&(a.beginPath(),e=b._offset+b._h-1,d?(a.moveTo(f,e),a.lineTo(f,e-b.majorTickHeight)):(a.moveTo(f,h-e),a.lineTo(f,h-e+b.majorTickHeight)),a.strokeStyle=b.scaleStyle,a.stroke()),p+=r[n];b.showCenter&&b.center>b._minVal&&b.center<b._maxVal&&(f=Math.round(t+w+(b.center-b._minVal)/b._range*
v),a.beginPath(),a.moveTo(f,s),a.lineTo(f,s+q),a.strokeStyle=b.scaleStyle,a.stroke());b.showScale&&(a.beginPath(),d?(a.moveTo(t,b._offset+b._h-1),a.lineTo(t+m,b._offset+b._h-1)):(a.moveTo(t,h-b._offset-b._h+1),a.lineTo(t+m,h-b._offset-b._h+1)),a.strokeStyle=b.scaleStyle,a.stroke());b.name&&(a.font=b.font,a.fillStyle=b.scaleStyle,f=d?b._offset+b._textSize/1.2:h-b._offset-b._textSize/2.2,a.save(),"y"===c?(a.scale(1,-1),a.translate(0,-this.h),e=h-f+b._textSize/1.9):e=f,a.fillText(b.name,t+m/2-a.measureText(b.name).width/
2,e),a.restore());"x"===c&&a.restore()};q.drawLegend=function(a,b){var c=0,d=0,f=1,e=1.2*parseInt(a.font.split(" ")[0]),g,h,k=a.inside?this.nwoy:this.settings.margin,l=a.inside?this.wox+5:this.settings.margin,n=a.inside?this.wsw:this.w,p=a.inside?this.wsh:this.h;this.ctx.font=a.font;for(g=0;g<this.datasets.length;g++)void 0===this.datasets[g].name&&(this.datasets[g].name="Series "+(g+1)),"bottom"===a.position||"top"===a.position?(d+this.ctx.measureText(this.datasets[g].name).width+e+e>n&&(f+=1,d=
0),d+=this.ctx.measureText(this.datasets[g].name).width+e+e,c=e*f):((h=this.ctx.measureText(this.datasets[g].name).width)>d&&(d=h),c=d+e);if(!b)for(d=0,f=1,g=0;g<this.datasets.length;g++)this.ctx.fillStyle=this.datasets[g].fillStyle,this.ctx.strokeStyle=this.datasets[g].strokeStyle,"bottom"===a.position||"top"===a.position?(d+this.ctx.measureText(this.datasets[g].name).width+e+e>n&&(f+=1,d=0),h=("bottom"===a.position?p+k-c:k)+(f-1)*e+3,this.ctx.fillRect(d+l,h,e-6,e-6),this.ctx.strokeRect(d+l,h,e-
6,e-6),this.ctx.fillText(this.datasets[g].name,d+e+l,h+e/1.35),d+=this.ctx.measureText(this.datasets[g].name).width+e+e):(h="right"===a.position?n+l-c:l,this.ctx.fillRect(h,k+(f-1)*e+3,e-6,e-6),this.ctx.strokeRect(h,k+(f-1)*e+3,e-6,e-6),this.ctx.fillText(this.datasets[g].name,h+e,k+(f-1)*e+e/1.35),f+=1);return c};q.calcAxisSpace=function(a,b,c){var d,f,e,g;a._textSize=void 0!==a.font?parseInt(a.font.split(" ")[0]):0;a._h=0;a._h+=a.showScale?1:0;a._h+=a.showScale?a.majorTickHeight:0;a._h+=a.name?a._textSize:
0;if(a.showLabels){d=0;for(f=a._minVal;f<=a._maxVal;f+=a._step)e=a._labels&&void 0!==a._labels[f]?b.measureText(a.labelFormat(a._labels[f])).width:b.measureText(a.labelFormat(f)).width,g=a._textSize,e=l.math.bboxrot(e,g,a.labelRotation+("x"===c?90:0)).width,e>d&&(d=e);a._h+=d}return a};q.redraw=function(){var a,b,c;this.wsw=this.w-2*this.settings.margin;this.wsh=this.h-2*this.settings.margin;this.nwoy=this.nwox=this.woy=this.wox=this.settings.margin;this.settings.showLegend&&!this.settings.legend.inside&&
(c=this.drawLegend(this.settings.legend,!0)+this.settings.margin,"bottom"===this.settings.legend.position?(this.woy+=c,this.wsh-=c):"top"===this.settings.legend.position?(this.nwoy+=c,this.wsh-=c):"left"===this.settings.legend.position?(this.wox+=c,this.wsw-=c):"right"===this.settings.legend.position&&(this.nwox+=c,this.wsw-=c));for(a in this.yAxises)this.yAxises.hasOwnProperty(a)&&(this.yAxises[a]=this.calcAxisSpace(this.yAxises[a],this.ctx,"y"),this.wsw-=this.yAxises[a]._h,this.yAxises[a]._offset=
a%2?this.wox:this.nwox,a%2?this.wox+=this.yAxises[a]._h:this.nwox+=this.yAxises[a]._h);for(a in this.xAxises)this.xAxises.hasOwnProperty(a)&&(this.xAxises[a]=this.calcAxisSpace(this.xAxises[a],this.ctx,"x"),this.wsh-=this.xAxises[a]._h,this.xAxises[a]._offset=a%2?this.woy:this.nwoy,a%2?this.woy+=this.xAxises[a]._h:this.nwoy+=this.xAxises[a]._h);c=this.ctx;c.clearRect(0,0,this.w,this.h);c.save();c.translate(.5,.5);c.scale(1,-1);c.translate(0,-this.h);for(a in this.yAxises)this.yAxises.hasOwnProperty(a)&&
this.drawAxis(c,this.yAxises[a],"x",a%2);for(a in this.xAxises)this.xAxises.hasOwnProperty(a)&&this.drawAxis(c,this.xAxises[a],"y",a%2);for(a=this.datasets.length-1;0<=a;a--)if(b=this.datasets[a],void 0!==l.renderers[b.type]||"area"===b.type)if("line"===b.type||"area"===b.type)l.renderers.line(this,c,b,this.xAxises[b.x.axis],this.yAxises[b.y.axis]);else l.renderers[b.type](this,c,b,this.xAxises[b.x.axis],this.yAxises[b.y.axis]);else console.error('Grapho: Missing renderer "'+b.type+'", cannot render dataset.');
c.restore();this.settings.showLegend&&this.drawLegend(this.settings.legend,!1)};q.resize=function(){"auto"===(this.w=this.container.width)&&(this.w=getComputedStyle(this.dest,null).getPropertyValue("width"));"auto"===(this.h=this.container.height)&&(this.h=getComputedStyle(this.dest,null).getPropertyValue("height"));this.canvas.height=this.h=parseInt(this.h);this.canvas.width=this.w=parseInt(this.w);this.redraw();return this};window.addEventListener("resize",function(){for(var a,b=0;a=u[b++];)a.resize()});
return s});